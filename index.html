<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scavenger Hunt with NPC Dialogue</title>
<style>
  :root {
    --accent: #00ffcc;
    --accent-2: #00cc88;
    --bg: #1a1a1a;
  }
  html, body {
    margin: 0; height: 100%;
    background: var(--bg);
    color: var(--accent);
    font-family: monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  #gameContainer {
    position: relative;
    width: 540px;
    height: 270px;
  }
  canvas#gameCanvas {
    border: 2px solid var(--accent);
    background-size: cover;
    background-position: center;
    display: block;
  }
  #fadeOverlay {
    position: absolute;
    inset: 0;
    background: black;
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms ease;
    z-index: 50;
  }
  #startBtn {
    margin-top: 12px;
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    background: var(--accent-2);
    color: black;
    font-size: 1rem;
    cursor: pointer;
  }
  #dialogueBox {
    width: 80%;
    max-width: 820px;
    height: 140px;
    background: rgba(0,0,0,0.85);
    border: 2px solid var(--accent);
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-sizing: border-box;
    position: relative;
    visibility: hidden;
    opacity: 0;
    transition: opacity 220ms ease, visibility 220ms linear;
    z-index: 60;
    margin-top: 10px;
  }
  #dialogueBox.show { visibility: visible; opacity: 1; }
  #portrait {
    width: 96px;
    height: 96px;
    border: 2px solid var(--accent);
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
  }
  #dialogueText {
    flex: 1;
    font-size: 1.05rem;
    white-space: pre-wrap;
    overflow-y: auto;
    max-height: 120px;
  }
  #arrowControls {
    margin-top: 12px;
    display: flex;
    gap: 24px;
    visibility: hidden;
    opacity: 0;
    transition: opacity 200ms ease, visibility 200ms linear;
  }
  #arrowControls.show { visibility: visible; opacity: 1; }
  .arrowBtn {
    width: 70px;
    height: 70px;
    border-radius: 10px;
    border: none;
    font-size: 2rem;
    background: var(--accent-2);
    color: black;
    cursor: pointer;
    box-shadow: 0 0 8px var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    touch-action: manipulation;
  }
  .arrowBtn:active { transform: translateY(1px); filter: brightness(0.95); }
  #interactBtn {
    margin-top: 10px;
    padding: 10px 22px;
    font-size: 1.1rem;
    background: var(--accent-2);
    border: none;
    border-radius: 8px;
    color: black;
    cursor: pointer;
    opacity: 0;
    display: none;
    transition: opacity 0.4s ease;
  }
  .italic {
    font-style: italic;
  }
</style>
</head>

<div id="riddleOverlay" style="
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.95);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: var(--accent);
  z-index: 100;
  font-family: monospace;
  padding: 20px;
">
  <div id="riddleText" style="
    margin-bottom: 15px;
    font-size: 1rem;
    text-align: center;
    max-width: 90%;
    width: 100%;
  "></div>
  <input id="riddleAnswer" type="text" placeholder="Your answer..." style="
    padding: 8px 12px;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    margin-bottom: 10px;
    max-width: 90%;
    width: 100%;
    box-sizing: border-box;
  ">
  <button id="riddleSubmit" style="
    padding: 8px 16px;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background: var(--accent-2);
    color: black;
    cursor: pointer;
    max-width: 90%;
    width: 100%;
    box-sizing: border-box;
  ">Submit</button>
</div>


<body>

<div id="gameContainer">
  <canvas id="gameCanvas" width="540" height="270"></canvas>
  <div id="fadeOverlay"></div>
</div>

<button id="startBtn" disabled>Loading assets…</button>

<div id="dialogueBox">
  <div id="portrait" style="background-image: url('images/captain-sprite.png');"></div>
  <div id="dialogueText"></div>
</div>

<div id="arrowControls">
  <button id="leftBtn" class="arrowBtn" aria-label="Move Left">←</button>
  <button id="rightBtn" class="arrowBtn" aria-label="Move Right">→</button>
</div>

<button id="interactBtn">Interact</button>

<script>
const STAGE_BACKGROUNDS = [
  'images/background.jpg',
  'images/background1.jpg',
  'images/background2.png',
  'images/background3.jpg'
];

const SPRITES = {
  right: 'images/girl-sprite-right.png',
  left:  'images/girl-sprite-left.png',
  captainPortrait: 'images/captain-sprite.png',
  npc: 'images/homeless-sprite.png',
  npc2: 'images/terminal.png',
   npc3: 'images/man-sprite.png',


};

const AUDIO = {
  voice: 'audio/voice.mp3',
  bgm: 'audio/bgmusic.mp3',
  npc2Voice: 'audio/npc-voice2.mp3',
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const fadeOverlay = document.getElementById('fadeOverlay');
const startBtn = document.getElementById('startBtn');
const dialogueBox = document.getElementById('dialogueBox');
const dialogueText = document.getElementById('dialogueText');
const portrait = document.getElementById('portrait');
const arrowControls = document.getElementById('arrowControls');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const interactBtn = document.getElementById('interactBtn');

const SPRITE_SIZE = 96;
let posX = canvas.width/2 - SPRITE_SIZE/2;
let posY = canvas.height/2 - SPRITE_SIZE/2 + 89;
let swayOffset = 0, swayDirection = 1;
let animState = 'idle', lastDirection = 'right';
let keys = { left:false, right:false };
let currentStage = 0, isTransitioning = false;

const npc = { x: canvas.width - 150, y: posY, width: SPRITE_SIZE, height: SPRITE_SIZE, isTalking: false, swayOffset: 0, swayDirection: 1 };
const npc2 = { x: 235, y: posY, width: SPRITE_SIZE, height: SPRITE_SIZE, isTalking: false, swayOffset: 0, swayDirection: 1 };
const npc3 = {
  x: 100, // choose an x position
  y: posY, // same vertical level as the player
  width: SPRITE_SIZE,
  height: SPRITE_SIZE,
  isTalking: false,
  swayOffset: 0,
  swayDirection: 1
};


const npcScriptText = [
  { text: "Come back have you? ", duration: 1000 },
  { text: "Haha, they always do.", duration: 1000 },
  { text: "You didn't give me any flax back on Zygmore...", duration: 1000 },
  { text: "So I wont make it easy for you.", duration: 1000 },
 { text: "So, timetraveller, riddle me this...", duration: 1000 },
];

const npc2ScriptText = [
  { text: "<span class='italic'>TERMINAL SAYS<br> Find the place in South London to continue. </span>", duration: 10000 }
];

const npc3ScriptText = [
  { text: "Thank you -ah", duration: 1900 },
  { text: "Hope -ah You enjoy - ah", duration: 1900 },
];

const imagesToLoad = [...STAGE_BACKGROUNDS, SPRITES.right, SPRITES.left, SPRITES.captainPortrait, SPRITES.npc, SPRITES.npc2,SPRITES.npc3 ];
const preloaded = {};
let loadedCount = 0;

imagesToLoad.forEach(src => {
  const img = new Image();
  img.onload = () => { loadedCount++; preloaded[src] = img; if(loadedCount === imagesToLoad.length) onAllAssetsLoaded(); };
  img.onerror = () => { loadedCount++; if(loadedCount === imagesToLoad.length) onAllAssetsLoaded(); };
  img.src = src;
});

const npcAudioRiddleCorrect = new Audio('audio/npc-voice2.mp3');
const voiceAudio = new Audio(AUDIO.voice);
const bgmusic = new Audio(AUDIO.bgm); bgmusic.loop = true; bgmusic.volume = 0.36;
const npcAudio = new Audio(AUDIO.npcVoice);
const npc2Audio = new Audio(AUDIO.npc2Voice);
const npc3Audio = new Audio(AUDIO.npc3Voice);


function onAllAssetsLoaded(){
  canvas.style.backgroundImage = `url('${STAGE_BACKGROUNDS[currentStage]}')`;
  startBtn.disabled = false;
  startBtn.textContent = 'Start Adventure';
}

function drawSprite(x, y){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(currentStage === 2){
    const npcImg = preloaded[SPRITES.npc];
    if(npcImg) {
      npc.swayOffset += npc.swayDirection * 0.3;
      if(npc.swayOffset > 3 || npc.swayOffset < -3) npc.swayDirection *= -1;
      ctx.drawImage(npcImg, npc.x + npc.swayOffset, npc.y, npc.width, npc.height);
    }
  }

  if(currentStage === 3){
    const npc2Img = preloaded[SPRITES.npc2];
    if(npc2Img) {
      ctx.drawImage(npc2Img, npc2.x + npc2.swayOffset, npc2.y, npc2.width, npc2.height);
    }
  }

  if(currentStage === 0){
  const npc3Img = preloaded[SPRITES.npc3];
  if(npc3Img){
    npc3.swayOffset += npc3.swayDirection * 0.3;
    if(npc3.swayOffset > 3 || npc3.swayOffset < -3) npc3.swayDirection *= -1;
    ctx.drawImage(npc3Img, npc3.x + npc3.swayOffset, npc3.y, npc3.width, npc3.height);
  }
}


  const playerImg = lastDirection === 'left' ? preloaded[SPRITES.left] : preloaded[SPRITES.right];
  if(playerImg) ctx.drawImage(playerImg, x + swayOffset, y, SPRITE_SIZE, SPRITE_SIZE);
}

function changeStage(direction){
  if(isTransitioning) return;
  isTransitioning = true;
  fadeOverlay.style.opacity = '1';
  setTimeout(() => {
    currentStage = (currentStage + direction + STAGE_BACKGROUNDS.length) % STAGE_BACKGROUNDS.length;
    canvas.style.backgroundImage = `url('${STAGE_BACKGROUNDS[currentStage]}')`;
    if(direction === 1){ posX = 8; lastDirection = 'right'; }
    else { posX = canvas.width - SPRITE_SIZE - 8; lastDirection = 'left'; }
    fadeOverlay.style.opacity = '0';
    setTimeout(() => { isTransitioning = false; }, 320);
  }, 320);
}

function animateSprite(){
  if(keys.left){ posX -= 4; animState = 'walking'; lastDirection = 'left'; }
  else if(keys.right){ posX += 4; animState = 'walking'; lastDirection = 'right'; }
  else animState = 'idle';

  posX = Math.max(0, Math.min(posX, canvas.width - SPRITE_SIZE));

  if(!isTransitioning && posX <= 0 && lastDirection === 'left') changeStage(-1);
  else if(!isTransitioning && posX >= canvas.width - SPRITE_SIZE && lastDirection === 'right') changeStage(1);

  // NPC1 interaction
  if(currentStage === 2){
    const distX = Math.abs((posX + SPRITE_SIZE/2) - (npc.x + npc.width/2));
    const distY = Math.abs((posY + SPRITE_SIZE/2) - (npc.y + npc.height/2));
    if(distX < 80 && distY < 80 && !npc.isTalking && !introPlaying && !npcDialoguePlaying && !npc2DialoguePlaying) {
      showInteractButton(() => { startNpcDialogue(); });
    } else {
      hideInteractButton();
    }
  }

  // NPC2 interaction
  if(currentStage === 3){
    const distX2 = Math.abs((posX + SPRITE_SIZE/2) - (npc2.x + npc2.width/2));
    const distY2 = Math.abs((posY + SPRITE_SIZE/2) - (npc2.y + npc2.height/2));
    if(distX2 < 80 && distY2 < 80 && !npc2.isTalking && !introPlaying && !npc2DialoguePlaying && !npcDialoguePlaying) {
      showInteractButton(() => { startNpc2Dialogue(); });
    } else {
      hideInteractButton();
    }
  }

  // NPC3 interaction
if(currentStage === 0){
  const distX3 = Math.abs((posX + SPRITE_SIZE/2) - (npc3.x + npc3.width/2));
  const distY3 = Math.abs((posY + SPRITE_SIZE/2) - (npc3.y + npc3.height/2));
  if(distX3 < 80 && distY3 < 80 && !npc3.isTalking && !introPlaying && !npcDialoguePlaying && !npc2DialoguePlaying) {
    showInteractButton(() => { startNpc3Dialogue(); });
  } else {
    hideInteractButton();
  }
}


  if(animState === 'idle'){ swayOffset += swayDirection * 0.5; if(swayOffset > 3 || swayOffset < -3) swayDirection *= -1; }
  else swayOffset = 0;

  drawSprite(posX, posY);
  requestAnimationFrame(animateSprite);
}

function typeSentence(sentence, callback) {
  dialogueText.textContent = '';
  let index = 0;
  function typeNext() {
    if (index < sentence.length) {
      dialogueText.textContent += sentence.charAt(index++);
      setTimeout(typeNext, 40);
    } else { if (callback) callback(); }
  }
  typeNext();
}

function showDialogueNoHide(text, callback){
  dialogueBox.classList.add('show');
  typeSentence(text, callback);
}

function hideDialogue(){ dialogueBox.classList.remove('show'); }

// NPC1 dialogue sequence
let npcDialogueIndex = 0, npcDialoguePlaying = false;
function startNpcDialogue(){
  npc.isTalking = true;
  hideInteractButton();
  npcAudio.currentTime = 0;
  npcAudio.play();

    setTimeout(() => {
    npcAudio.pause();
    npcAudio.currentTime = 0; // Reset the audio
  }, 14850);

  playNpcDialogueSequence();
}
function playNpcDialogueSequence(onComplete) {
  npcDialoguePlaying = true;
  npcDialogueIndex = 0;
  portrait.style.backgroundImage = `url('${SPRITES.npc}')`;
  dialogueBox.classList.add('show');

  function nextLine() {
    if (npcDialogueIndex >= npcScriptText.length) {
      setTimeout(() => {
        dialogueBox.classList.remove('show');
        portrait.style.backgroundImage = `url('${SPRITES.captainPortrait}')`;
        npcDialoguePlaying = false;
        npc.isTalking = false;
        if (onComplete) onComplete(); // <-- call callback after last line
      }, 1000);
      return;
    }
    const line = npcScriptText[npcDialogueIndex];
    typeSentence(line.text, () => {
      npcDialogueIndex++;
      setTimeout(nextLine, line.duration || 3000);
    });
  }

  nextLine();
}

const npcPostRiddleScriptText = [
  { text: "Ah, correct! You really know your stuff.", duration: 2000 },
  { text: "Here's the info you need.", duration: 2000 },
  { text: "There's rummors going down about some place in South London...", duration: 2000 },
  { text: "Some shop or the other somewhere in Clapham.", duration: 2000 },
   { text: "I think they had their first date there or something, can't be too sure.", duration: 2000 },
   { text: "Now, get out of my face brokie.", duration: 2000 },
];

let npcPostRiddleIndex = 0;
let npcPostRiddlePlaying = false;

function playNpcDialogueSequencePostRiddle() {
  npcPostRiddlePlaying = true;
  npcPostRiddleIndex = 0;
  portrait.style.backgroundImage = `url('${SPRITES.npc}')`;
  dialogueBox.classList.add('show');

  function nextLine() {
    if (npcPostRiddleIndex >= npcPostRiddleScriptText.length) {
      setTimeout(() => {
        dialogueBox.classList.remove('show');
        portrait.style.backgroundImage = `url('${SPRITES.captainPortrait}')`;
        npcPostRiddlePlaying = false;
        npc.isTalking = false;
      }, 1000);
      return;
    }
    const line = npcPostRiddleScriptText[npcPostRiddleIndex];
    typeSentence(line.text, () => {
      npcPostRiddleIndex++;
      setTimeout(nextLine, line.duration || 3000);
    });
  }

  nextLine();
}


const riddleOverlay = document.getElementById('riddleOverlay');
const riddleText = document.getElementById('riddleText');
const riddleAnswer = document.getElementById('riddleAnswer');
const riddleSubmit = document.getElementById('riddleSubmit');

// Define your riddle and correct answer
const riddle = {
  question: "I speak without a mouth and hear without ears. I have nobody, but I come alive with wind. What am I?",
  answer: "echo"
};

function showRiddle(callback) {
  dialogueBox.classList.remove('show'); // hide dialogue while riddle is active
  riddleText.textContent = riddle.question;
  riddleAnswer.value = '';
  riddleOverlay.style.display = 'flex';
  riddleAnswer.focus();

  riddleSubmit.onclick = () => {
    if(riddleAnswer.value.trim().toLowerCase() === riddle.answer.toLowerCase()) {
      riddleOverlay.style.display = 'none';
      callback(); // continue NPC1 dialogue
    } else {
      riddleText.textContent = "Wrong! Try again.\n" + riddle.question;
      riddleAnswer.value = '';
      riddleAnswer.focus();
    }
  };
}

// Modify startNpcDialogue to show riddle first
function startNpcDialogue() {
  npc.isTalking = true;
  hideInteractButton();

  // Step 1: play initial NPC lines
  playNpcDialogueSequence(() => {
    // Step 2: show riddle after initial lines
    showRiddle(() => {
      // Step 3: play post-riddle audio and dialogue
      npcAudioRiddleCorrect.currentTime = 0;
      npcAudioRiddleCorrect.play();

      setTimeout(() => {
        playNpcDialogueSequencePostRiddle();
      }, 500);
    });
  });
}



// NPC2 dialogue sequence
let npc2DialogueIndex = 0, npc2DialoguePlaying = false;
function startNpc2Dialogue(){
  npc2.isTalking = true;
  hideInteractButton();
  npc2Audio.currentTime = 0;
  npc2Audio.play();
  playNpc2DialogueSequence();
}
function playNpc2DialogueSequence() {
  npc2DialoguePlaying = true;
  npc2DialogueIndex = 0;
  portrait.style.backgroundImage = `url('${SPRITES.npc2}')`;
  dialogueBox.classList.add('show');

  function nextLine() {
    if (npc2DialogueIndex >= npc2ScriptText.length) {
      setTimeout(() => {
        dialogueBox.classList.remove('show');
        portrait.style.backgroundImage = `url('${SPRITES.captainPortrait}')`;
        npc2DialoguePlaying = false;
        npc2.isTalking = false;
      }, 1000);
      return;
    }

    // Allow HTML for italics
    const line = npc2ScriptText[npc2DialogueIndex];
    dialogueText.innerHTML = line.text;

    npc2DialogueIndex++;
    setTimeout(nextLine, line.duration || 3000);
  }

  nextLine();
}

function startNpc3Dialogue(){
  npc3.isTalking = true;
  hideInteractButton();
  npc3Audio.currentTime = 0;
  npc3Audio.play().catch(err => console.warn('NPC3 audio blocked:', err));
  playNpc3DialogueSequence();
}

function playNpc3DialogueSequence() {
  npc3DialoguePlaying = true;
  npc3DialogueIndex = 0;
  portrait.style.backgroundImage = `url('${SPRITES.npc3}')`;
  dialogueBox.classList.add('show');

  function nextLine() {
    if(npc3DialogueIndex >= npc3ScriptText.length){
      setTimeout(() => {
        dialogueBox.classList.remove('show');
        portrait.style.backgroundImage = `url('${SPRITES.captainPortrait}')`;
        npc3DialoguePlaying = false;
        npc3.isTalking = false;
      }, 1000);
      return;
    }

    const line = npc3ScriptText[npc3DialogueIndex];
    typeSentence(line.text, () => {
      npc3DialogueIndex++;
      setTimeout(nextLine, line.duration || 3000);
    });
  }

  nextLine();
}


function showInteractButton(callback) {
  interactBtn.onclick = callback;
  interactBtn.style.display = 'inline-block';
  void interactBtn.offsetWidth;
  interactBtn.style.opacity = '1';
}
function hideInteractButton() {
  interactBtn.style.opacity = '0';
  interactBtn.addEventListener('transitionend', () => {
    if(interactBtn.style.opacity === '0') interactBtn.style.display = 'none';
  }, { once: true });
}

leftBtn.addEventListener('pointerdown', () => keys.left = true);
leftBtn.addEventListener('pointerup', () => keys.left = false);
leftBtn.addEventListener('pointerleave', () => keys.left = false);
rightBtn.addEventListener('pointerdown', () => keys.right = true);
rightBtn.addEventListener('pointerup', () => keys.right = false);
rightBtn.addEventListener('pointerleave', () => keys.right = false);
window.addEventListener('keydown', e => { if(e.key === 'ArrowLeft') keys.left = true; if(e.key === 'ArrowRight') keys.right = true; });
window.addEventListener('keyup', e => { if(e.key === 'ArrowLeft') keys.left = false; if(e.key === 'ArrowRight') keys.right = false; });

const scriptText = [
  { text: "I Hope you had a good rest break ", duration: 1500 },
  { text: "Now", duration: 1000 },
  { text: "I'm told our man on the ground might have more information.", duration: 1000 },
  { text: "Find him.", duration: 1000 },
  { text: "QUICKLY!", duration: 1000 },
];
let currentIndex = 0;
let introPlaying = true;

function showScriptSequenceNoFlicker() {
  if (currentIndex >= scriptText.length) {
    setTimeout(() => { hideDialogue(); introPlaying = false; }, 1000);
    return;
  }
  const line = scriptText[currentIndex];
  showDialogueNoHide(line.text, () => {
    currentIndex++;
    setTimeout(showScriptSequenceNoFlicker, line.duration || 3000);
  });
}

startBtn.addEventListener('click', () => {
  startBtn.style.display = 'none';
  arrowControls.classList.add('show');
  bgmusic.play();
  voiceAudio.currentTime = 0;
  voiceAudio.play().catch(err => console.warn('Voice play blocked:', err));
  currentIndex = 0;
  introPlaying = true;
  portrait.style.backgroundImage = `url('${SPRITES.captainPortrait}')`;
  showScriptSequenceNoFlicker();
  animateSprite();
});

canvas.addEventListener('contextmenu', e => e.preventDefault());
</script>

</body>
</html>
