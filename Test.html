<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scavenger Hunt with NPC Dialogue</title>



<style>
  :root {
    --accent: #00ffcc;
    --accent-2: #00cc88;
    --bg: #1a1a1a;
  }
  html, body {
    margin: 0; height: 100%;
    background: var(--bg);
    color: var(--accent);
    font-family: monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  #gameContainer {
    position: relative;
    width: 540px;
    height: 270px;
  }
  canvas#gameCanvas {
    border: 2px solid var(--accent);
    background-size: cover;
    background-position: center;
    display: block;
  }
  #fadeOverlay {
    position: absolute;
    inset: 0;
    background: black;
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms ease;
    z-index: 50;
  }
  #startBtn {
    margin-top: 12px;
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    background: var(--accent-2);
    color: black;
    font-size: 1rem;
    cursor: pointer;
  }
  #dialogueBox {
    width: 80%;
    max-width: 820px;
    height: 140px;
    background: rgba(0,0,0,0.85);
    border: 2px solid var(--accent);
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-sizing: border-box;
    position: relative;
    visibility: hidden;
    opacity: 0;
    transition: opacity 220ms ease, visibility 220ms linear;
    z-index: 60;
    margin-top: 10px;
  }
  #dialogueBox.show { visibility: visible; opacity: 1; }
  #portrait {
    width: 96px;
    height: 96px;
    border: 2px solid var(--accent);
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
  }
  #dialogueText {
    flex: 1;
    font-size: 1.05rem;
    white-space: pre-wrap;
    overflow-y: auto;
    max-height: 120px;
  }
  #arrowControls {
    margin-top: 12px;
    display: flex;
    gap: 24px;
    visibility: hidden;
    opacity: 0;
    transition: opacity 200ms ease, visibility 200ms linear;
  }
  #arrowControls.show { visibility: visible; opacity: 1; }
  .arrowBtn {
    width: 70px;
    height: 70px;
    border-radius: 10px;
    border: none;
    font-size: 2rem;
    background: var(--accent-2);
    color: black;
    cursor: pointer;
    box-shadow: 0 0 8px var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    touch-action: manipulation;
  }
  .arrowBtn:active { transform: translateY(1px); filter: brightness(0.95); }
  #interactBtn {
    margin-top: 10px;
    padding: 10px 22px;
    font-size: 1.1rem;
    background: var(--accent-2);
    border: none;
    border-radius: 8px;
    color: black;
    cursor: pointer;
    opacity: 0;
    display: none;
    transition: opacity 0.4s ease;
  }
  .italic { font-style: italic; }
</style>
</head>
<body>

<div id="gameContainer">
  <canvas id="gameCanvas" width="540" height="270"></canvas>
  <div id="fadeOverlay"></div>
</div>

<button id="startBtn" disabled>Loading assets…</button>

<div id="dialogueBox">
  <div id="portrait" style="background-image: url('images/captain-sprite.png');"></div>
  <div id="dialogueText"></div>
</div>

<div id="arrowControls">
  <button id="leftBtn" class="arrowBtn" aria-label="Move Left">←</button>
  <button id="rightBtn" class="arrowBtn" aria-label="Move Right">→</button>
</div>

<button id="interactBtn">Interact</button>

<script>
const STAGE_BACKGROUNDS = [
  'images/background.jpg', // stage 0
  'images/background1.jpg',
  'images/background2.png', // stage 2, homeless NPC
  'images/background3.jpg'  // stage 3, NPC2
];

const SPRITES = {
  right: 'images/girl-sprite-right.png',
  left:  'images/girl-sprite-left.png',
  captainPortrait: 'images/captain-sprite.png',
  npc: 'images/homeless-sprite.png',
  npc2: 'images/terminal.png',
  npc3: 'images/man-sprite.png'
};

const AUDIO = {
  voice: 'audio/voice.mp3',
  bgm: 'audio/bgmusic.mp3',
  npcVoice: 'audio/npc-voice.mp3',
  npc2Voice: 'audio/npc-voice2.mp3',
  npc3Voice: 'audio/npc-voice3.mp3'
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const fadeOverlay = document.getElementById('fadeOverlay');
const startBtn = document.getElementById('startBtn');
const dialogueBox = document.getElementById('dialogueBox');
const dialogueText = document.getElementById('dialogueText');
const portrait = document.getElementById('portrait');
const arrowControls = document.getElementById('arrowControls');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const interactBtn = document.getElementById('interactBtn');

const SPRITE_SIZE = 96;
let posX = canvas.width/2 - SPRITE_SIZE/2;
let posY = canvas.height/2 - SPRITE_SIZE/2 + 89;
let swayOffset = 0, swayDirection = 1;
let animState = 'idle', lastDirection = 'right';
let keys = { left:false, right:false };
let currentStage = 0, isTransitioning = false;

const npc = { x: canvas.width - 150, y: posY, width: SPRITE_SIZE, height: SPRITE_SIZE, isTalking: false, swayOffset: 0, swayDirection: 1 };
const npc2 = { x: 235, y: posY, width: SPRITE_SIZE, height: SPRITE_SIZE, isTalking: false, swayOffset: 0, swayDirection: 1 };
const npc3 = { x: 100, y: posY, width: SPRITE_SIZE, height: SPRITE_SIZE, isTalking: false, swayOffset: 0, swayDirection: 1 };

const miniGameModal = document.getElementById('miniGameModal');
const riddleInput = document.getElementById('riddleInput');
const riddleSubmit = document.getElementById('riddleSubmit');
const riddleFeedback = document.getElementById('riddleFeedback');

function startMiniGame() {
  miniGameModal.style.display = 'flex';
  hideInteractButton();
}

riddleSubmit.addEventListener('click', () => {
  const answer = riddleInput.value.trim().toLowerCase();
  if(answer === 'keyboard'){
    riddleFeedback.textContent = "Correct! Here's more info...";
    setTimeout(() => {
      miniGameModal.style.display = 'none';
      riddleInput.value = '';
      riddleFeedback.textContent = '';
    }, 1200);
  } else {
    riddleFeedback.textContent = "Nope, try again!";
    riddleInput.value = '';
  }
});

// Dialogue typing helper
function typeSentence(sentence, callback) {
  dialogueText.textContent = '';
  let index = 0;
  function typeNext() {
    if (index < sentence.length) {
      dialogueText.textContent += sentence.charAt(index++);
      setTimeout(typeNext, 40);
    } else { if(callback) callback(); }
  }
  typeNext();
}

function showDialogue(text, callback){
  dialogueBox.classList.add('show');
  typeSentence(text, callback);
}

function hideDialogue(){ dialogueBox.classList.remove('show'); }

function showInteractButton(callback) {
  interactBtn.onclick = callback;
  interactBtn.style.display = 'inline-block';
  void interactBtn.offsetWidth;
  interactBtn.style.opacity = '1';
}
function hideInteractButton() {
  interactBtn.style.opacity = '0';
  interactBtn.addEventListener('transitionend', () => {
    if(interactBtn.style.opacity === '0') interactBtn.style.display = 'none';
  }, { once: true });
}

// Preload images
const imagesToLoad = [...STAGE_BACKGROUNDS, SPRITES.right, SPRITES.left, SPRITES.captainPortrait, SPRITES.npc, SPRITES.npc2,SPRITES.npc3 ];
const preloaded = {};
let loadedCount = 0;
imagesToLoad.forEach(src => {
  const img = new Image();
  img.onload = () => { loadedCount++; preloaded[src] = img; if(loadedCount === imagesToLoad.length) onAllAssetsLoaded(); };
  img.onerror = () => { loadedCount++; if(loadedCount === imagesToLoad.length) onAllAssetsLoaded(); };
  img.src = src;
});

const voiceAudio = new Audio(AUDIO.voice);
const bgmusic = new Audio(AUDIO.bgm); bgmusic.loop = true; bgmusic.volume = 0.36;
const npcAudio = new Audio(AUDIO.npcVoice);
const npc2Audio = new Audio(AUDIO.npc2Voice);
const npc3Audio = new Audio(AUDIO.npc3Voice);

function onAllAssetsLoaded(){
  canvas.style.backgroundImage = `url('${STAGE_BACKGROUNDS[currentStage]}')`;
  startBtn.disabled = false;
  startBtn.textContent = 'Start Adventure';
}

// NPC Scripts
const npcScriptText = [
  "You're probably wondering how I got here.",
  "They paid me 55 flax to follow you here and make sure you stay on track",
  "You need to go to some Massage parlour or some shit like that.",
  "I only like the ones with happy endings.",
  "...",
  "By the way you're still a nigg-"
];
const npc2ScriptText = [
  "<span class='italic'>TERMINAL SAYS<br> Head to LAYANA - Belsize Hill to continue. </span>"
];
const npc3ScriptText = [
  "Wagwan piff ting, what's that BBM pin?"
];

// Animation & drawing
function drawSprite() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw stage NPCs
  if(currentStage === 0){
    const npc3Img = preloaded[SPRITES.npc3];
    if(npc3Img){
      npc3.swayOffset += npc3.swayDirection * 0.3;
      if(npc3.swayOffset > 3 || npc3.swayOffset < -3) npc3.swayDirection *= -1;
      ctx.drawImage(npc3Img, npc3.x + npc3.swayOffset, npc3.y, npc3.width, npc3.height);
    }
  }
  if(currentStage === 2){
    const npcImg = preloaded[SPRITES.npc];
    if(npcImg) {
      npc.swayOffset += npc.swayDirection * 0.3;
      if(npc.swayOffset > 3 || npc.swayOffset < -3) npc.swayDirection *= -1;
      ctx.drawImage(npcImg, npc.x + npc.swayOffset, npc.y, npc.width, npc.height);
    }
  }
  if(currentStage === 3){
    const npc2Img = preloaded[SPRITES.npc2];
    if(npc2Img) ctx.drawImage(npc2Img, npc2.x + npc2.swayOffset, npc2.y, npc2.width, npc2.height);
  }

  // Draw player
  const playerImg = lastDirection === 'left' ? preloaded[SPRITES.left] : preloaded[SPRITES.right];
  if(playerImg) ctx.drawImage(playerImg, posX + swayOffset, posY, SPRITE_SIZE, SPRITE_SIZE);
}

let introPlaying = true;
let npcDialoguePlaying = false;
let npc2DialoguePlaying = false;
let npc3DialoguePlaying = false;

function animateSprite() {
  if(keys.left){ posX -= 4; animState='walking'; lastDirection='left'; }
  else if(keys.right){ posX += 4; animState='walking'; lastDirection='right'; }
  else animState='idle';
  posX = Math.max(0, Math.min(posX, canvas.width - SPRITE_SIZE));

  // Show interact buttons when near NPC
  if(currentStage === 2 && !npc.isTalking && !introPlaying && !npcDialoguePlaying) {
    const dx = Math.abs(posX + SPRITE_SIZE/2 - (npc.x + npc.width/2));
    const dy = Math.abs(posY + SPRITE_SIZE/2 - (npc.y + npc.height/2));
    if(dx < 80 && dy < 80) showInteractButton(startNpcDialogue);
    else hideInteractButton();
  }
  else if(currentStage === 3 && !npc2.isTalking && !introPlaying && !npc2DialoguePlaying) {
    const dx = Math.abs(posX + SPRITE_SIZE/2 - (npc2.x + npc2.width/2));
    const dy = Math.abs(posY + SPRITE_SIZE/2 - (npc2.y + npc2.height/2));
    if(dx < 80 && dy < 80) showInteractButton(startNpc2Dialogue);
    else hideInteractButton();
  }
  else if(currentStage === 0 && !npc3.isTalking && !introPlaying && !npc3DialoguePlaying) {
    const dx = Math.abs(posX + SPRITE_SIZE/2 - (npc3.x + npc3.width/2));
    const dy = Math.abs(posY + SPRITE_SIZE/2 - (npc3.y + npc3.height/2));
    if(dx < 80 && dy < 80) showInteractButton(startNpc3Dialogue);
    else hideInteractButton();
  }
  else hideInteractButton();

  if(animState==='idle'){ swayOffset+=swayDirection*0.5; if(swayOffset>3||swayOffset<-3) swayDirection*=-1; }
  else swayOffset=0;

  drawSprite();
  requestAnimationFrame(animateSprite);
}

// NPC Dialogue handlers
function playDialogueSequence(npcObj, npcScript, npcAudioObj, callback){
  let index=0;
  npcObj.isTalking = true;
  npcAudioObj.currentTime = 0;
  npcAudioObj.play().catch(()=>{});
  dialogueBox.classList.add('show');
  portrait.style.backgroundImage = `url('${SPRITES[Object.keys(SPRITES).find(k=>SPRITES[k]===npcObj.sprite||SPRITES.npc)]}')`;
  
  function nextLine(){
    if(index>=npcScript.length){
      setTimeout(()=>{
        dialogueBox.classList.remove('show');
        portrait.style.backgroundImage=`url('${SPRITES.captainPortrait}')`;
        npcObj.isTalking=false;
        if(callback) callback();
      },1000);
      return;
    }
    const line = npcScript[index];
    if(line.includes('<span')) dialogueText.innerHTML = line;
    else typeSentence(line, ()=>{});
    index++;
    setTimeout(nextLine, 3000);
  }
  nextLine();
}

function startNpcDialogue(){ playDialogueSequence(npc, npcScriptText, npcAudio, startMiniGame); }
function startNpc2Dialogue(){ playDialogueSequence(npc2, npc2ScriptText, npc2Audio); }
function startNpc3Dialogue(){ playDialogueSequence(npc3, npc3ScriptText, npc3Audio); }

// Stage transition
function changeStage(direction){
  if(isTransitioning) return;
  isTransitioning = true;
  fadeOverlay.style.opacity='1';
  setTimeout(()=>{
    currentStage = (currentStage + direction + STAGE_BACKGROUNDS.length) % STAGE_BACKGROUNDS.length;
    canvas.style.backgroundImage=`url('${STAGE_BACKGROUNDS[currentStage]}')`;
    posX = direction===1? 8 : canvas.width-SPRITE_SIZE-8;
    lastDirection = direction===1?'right':'left';
    fadeOverlay.style.opacity='0';
    setTimeout(()=>{isTransitioning=false;},320);
  },320);
}

// Controls
leftBtn.addEventListener('pointerdown',()=>keys.left=true);
leftBtn.addEventListener('pointerup',()=>keys.left=false);
leftBtn.addEventListener('pointerleave',()=>keys.left=false);
rightBtn.addEventListener('pointerdown',()=>keys.right=true);
rightBtn.addEventListener('pointerup',()=>keys.right=false);
rightBtn.addEventListener('pointerleave',()=>keys.right=false);

window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft') keys.left=true; else if(e.key==='ArrowRight') keys.right=true; });
window.addEventListener('keyup',(e)=>{ if(e.key==='ArrowLeft') keys.left=false; else if(e.key==='ArrowRight') keys.right=false; });

startBtn.addEventListener('click',()=>{
  startBtn.style.display='none';
  arrowControls.classList.add('show');
  bgmusic.play().catch(()=>{});
  animateSprite();
});
</script>

</body>
</html>
